# Glucose Prediction

All of Loop's insulin dosing decisions are based on the difference between the target glucose and Loop's glucose prediction. Therefore, the best way to understand Loop's recommendations is to understand the prediction.  There are four factors that determine Loop's prediction: insulin activity, carbohydrate activity, glucose momentum and, optionally, retrospective correction.  Loop makes a new prediction every five minutes and each time it does so, it generates a vector of expected changes to the prevailing glucose value for each effect, for each point in the future.  Loop then combines these effects together to generate a predicted glucose curve.  The end of this curve is the "eventual" glucose prediction time.  This time is at the end of the Duration of Insulin Action - the DIA, which you have supplied in the settings screen.  It makes sense to anchor the dosing recommendations on the prediction at the end of the DIA because that's when all the insulin is expected to be absorbed, so from that point the BG should be stable - unless there are slow burning carbs that are longer than the DIA, which is a special case discussed below.  Since Loop generates a complete BG curve, including the path from the current BG to the eventual BG, it can also check to make sure there won't be any undesired lows along the way.  It compares every BG in the curve to the Minimum BG Guard Level, and takes action accordingly as described above.

You can see the individual contributions of these effects by tapping on the predicted glucose graph on Loop's status screen. In addition, by tapping on the Active Carbohydrates screen, you can see important information about carbohydrate absorption and its effect on the glucose prediction, which is discussed in more detail below.

Insulin absorption curves: to be able to have an accurate prediction of the BG at any point in time, Loop needs a model for how insulin is absorbed by the body and therefore its expected effect on BG at every point in the future.  You are probably used to thinking about "peak", and maybe the "tail", as key things to keep track of to avoid late lows and decide pre-bolusing, but the Loop prediction can do the math much more precisely and give you an estimate for what impact insulin is expected to have on your BG in every 5 minute interval between now and when all the insulin is gone.  And, it can do this across multiple boluses and temp-basals, which can help to explain why sometimes BG is moving in a way that seems inconsistent with the IOB, due to different insulin absorption rates across potentially ofsetting boluses and temp basals.  This, together with incorporating the impact on IOB of temp basals, is a significant benefit of Loop compared to just having to rely on the IOB reported by the pump.

In the current version of Loop, insulin is assumed to absorb according to curves first published by Walsh.  These curves are then squeezed or stretched by the DIA that you input.  The results are illustrated in the tables below.  



The curves in question are fourth order polynomials.  This is just a mathematical convenience that Walsh used to fit curves that had been obtained empirically.  The coefficients in the polynomial don't "mean" anything - they don't, for example, relate to peak time or to DIA explicitly.  The Loop community is currently exploring updating these mathematical functions to be more flexible, accurate and intuitive. Among other things, alternate forms of these functions would allow Loop users to more accurately reflect the earlier peak of faster acting insulins like Fiasp, while still recognizing that a tail exists.  Shortening the DIA of the existing curve shape and thereby "squeezing" the curve risks ignoring significant amounts of insulin in the tail.  And if Loop doesn't know about the insulin in the tail, the prediction will be wrong, and all the recomendations will therefore also be wrong.  There is an extensive discussion of these issues in #388, but it is not necessary to understand the math in detail to have a very good understanding of what Loop is doing.

Carbohydrate absorption: version 1.4.0 implements dynamic carbohydrate absorption, which is a major step forward for Loop.  The write-up associated with the original release of dynamic carbs is #507.  What follows is a simplified explanation with an emphasis on the prediction.

The most important aspect of dynamic carbs is that carbohydrates on board (COB), which are the ones affecting the glucose prediction, are equal to the carbs you entered minus carbs absorbed.  This is change from prior versions where COB was decayed according to a mathematical function, without reference to observed absorption. Carbs absorbed are derived by looking at the BG history. Since Loop knows the expected effect on BG of all insulin taken, it can assume that immediately after meals, any difference between the predicted BG from insulin alone and the observed BG is due to the absorption of carbs.  This is a key enhancement because it makes the Loop prediction much less sensitive to both the user's guess of carb absorption time and the mathematical modeling of the absorption profile in the future.  In fact, 1.4.0 makes a very simple assumption: for all remaining carbs that it hasn't observed being absorbed, it assumes that they will absorb linearly.  And it derives the absorption rate by simply dividing carbs by its assumed absorption time.  So, if you input 36 grams of carbs, and Loop is using absorption of 3 hours, absorption equals 36/180, or .20 grams/minute, or 1.0 grams/5 minutes.  If you assume an ISF of 70, and an I/C of 7, the CSF (BG impact/gram of carbs consumed) will be 10 mg/dl/gram. So this absorption rate equates to a BG increase of `(1.0 grams/5 minutes * 10 mg/dl/gram = 10 mg/dl/5 minutes)`.  Loop makes one modification to your inputs: it assumes that absorption time will be 50% longer than what you input.  So the example above, where Loop is using 3 hour absorption time, implies that you inputted a 2 hour absorption time.  This has the effect of lowering the assumed future absorption rate by a factor of 1.5. This is a conservative choice that helps to keep Loop from high temping too aggressively for carbs that are expected to absorb in the future, if that absorption is not actually happening for whatever reason. This absorption rate also serves as a minimum rate to "expire" the carbs if, for whatever reason (exercise, meal not consumed) the absorption is never observed. Continuing with the above example, if it turns out that 16 of the carbs were very fast burning and are absorbed in the first 30 minutes, that will show up in higher BG, and Loop will assume they have been absorbed.  The 16 grams will then be deducted from the COB, leaving 20 grams of COB.  Those 20 grams will be decayed at the same original rate of .2 grams/minute - resulting in a prediction that the remaining 20 grams of carbs will be absorbed in 100 minutes, or a total of 130 minutes.  Loop then incorporates this absorption rate into the predicted BG curve. 

The carbohydrate absorption screen allows you to see how many carbs Loop actually observed being absorbed.  Checking this screen can help with carb counting, and also give you a sense of whether there are other factors at play - exercise, basal rates needing to be modified, stress, etc. The screen also allows you to see what actual absorption times have been.  However, it's important to note that for meals that are expected to absorb inside the DIA, the 50% conservative buffer makes very little difference, because the eventual prediction at the end of the DIA is unchanged - which means the bolus recommendation will not change as a result of the 50% buffer.  For example if you have a DIA of 3.5, and you input an absorption time of 2 hours, Loop is actually using 3 hours - but that still means it believes all carbs will be absorbed inside the DIA, so it recommends a full bolus for the carbs that you are consuming.  This stops being true if the absorption time inputted is greater than DIA/1.5, as further explained below.  And, if you are aggressively pre-bolusing, it's possible that the 50% buffer will produce a BG guard alert that in reality would not happen, because the carbs are absorbing faster and thereby avoiding hitting the BG guard.  Whether to adjust for this as a function of how aggressively you manage your diabetes, your willingness to risk lows, and your confidence in your ability to estimate absorption times.

The special case of slow burning carbs: dynamic carbohydrate absortion is particularly useful to improve the prediction for slow burning or fat-buffered carby meals like pizza and pasta.  For these types of meals, many people would use absortions of 4, 5, or 6 hours.  Loop then stretches these inputs further, by the factor of 1.5.  Taking the example of an input of 4 hours, Loop will actually assume 6.  If your DIA is 3, the Loop prediction, which only goes out to DIA, will only take into account half the carbs (3/6).  As a result, it will only recommend a bolus, or high temp for, half the carbs.  Then, as time passes, the rest of the carbs come inside the DIA; when that happens, the prediction goes up accordingly, and Loop can start high-temping pre-emptively, rather than waiting to see the actual (as opposed to predicted) rise in BG before starting the high temp.  This allows Loop to be more aggressive for these types of meals than simply under-bolusing and waiting for Loop to treat the observed rise after the fact - which is what many people would naturally do for slow burnbing meals.  And throughout this process, the original carb input is being decreased by the observed absorption of the carbs - which means that the amount of carbs affecting the prediction is decreasing, and so the contribution of those carbs to the prediction, and to the high temping decisions, gets smaller and smaller over time.  This then means that the mathematical choices relating to the carbohydrate absorption profile are less significant.

Retrospective correction: this feature adjusts the prediction by the previously observed error in the prediction, and thereby serves as a catch-all for "all other effects" - exercise, stress, hormones, etc.  RC takes the current BG and compares it to what it was predicted to be half an hour ago.  It takes that difference and adds it to the prediction, decaying the adjustment over half an hour back to zero.  So if you just decided to take the stairs and you are seeing BG drop more than insulin and carbs together would predict, this will show up as an error in Loop's prediction - actual BG will be lower than the predicted BG.  Loop will then take this difference and subtract it from the prediction for the next thirty minutes.  Since all the effects on the insulin curve are additive, this change also lowers the eventual prediction - which in turn leads it to deliver less insulin than it would have otherwise.  After some time has passed, the exercise effect might be gone, and Loop's prediction might be exactly accurate - and so RC does not modify the prediction, and Loop reverts to delivering your unmodified basal, assuming no COB or IOB.

Glucose momentum: In essence, glucose momentum says that what has been happening over the last 15 minutes is the best predictor of what will happen over the next 5 minutes, with that effect decaying over half an hour.  So, the prediction 5 minutes from now is almostly completely based on momentum.  The prediction 25 minutes from now is 1/6th momentum and 5/6th other effects (insulin, carb and RC). So the impact of momentum is "blended" with the other effects and stops contributing half an hour into the forecast.  Mathematically, Loop takes the regression slope coefficient of the last 4 glucose measurements (one every 5 minutes, so looking back 15 minutes including the current measurement) to get the recent trend.  This is pretty close to taking the average of the last 3 changes.  (You can see the changes in mg/dl/5 minutes in Nightscout - this is also the value that drives the trend arrows in Loop and the CGM).  Then, Loop looks forward to the next half hour and "blends" the calculated trend with the other effects.  In the special case of no COB and no IOB, glucose momentum approximates to taking the average change of the last 15 minutes, dividing it in half, and using it to project forward for the next half hour.  But, if there are any COB or IOB effects, those will "take over" the momentum effect as time pases, and this approximation won't apply.






  -  [CarbStore.getGlucoseEffects()](https://github.com/LoopKit/LoopKit/blob/master/CarbKit/CarbStore.swift#L615)
  - [DoseStore.getGlucoseEffects()](https://github.com/LoopKit/LoopKit/blob/master/InsulinKit/DoseStore.swift#L936)
  -  [GlucoseStore.getRecentMomentumEffect()](https://github.com/LoopKit/LoopKit/blob/master/GlucoseKit/GlucoseStore.swift#L244)
  - [LoopDataManager.updateRetrospectiveGlucoseEffect()](https://github.com/LoopKit/Loop/blob/master/Loop/Managers/LoopDataManager.swift#L445)
